---
layout: post
title: 机房搬迁总结
categories: python
description: 遇到的坑及解决办法
keywords: linux
---

  由于公司原有机房合同到期，因此需要搬迁。新机房和旧机房是在一栋楼，所以搬迁也就是从2楼搬到3楼。
  
  今天，搬迁工作终于接近尾声。从9月5号开始做准备，至今已经接近2个月。搬迁中虽然遇到过一些小问题，但好在都能在客户使用前得以解决。
  
  在此也要感谢网络组，dba同学的鼎力支持。
  
  此文主要记录搬迁中遇到的问题及解决办法。
  
  
  ## 信息统计
  
  共计69台机器，其中90%机器系统均为ESXI 5.x，虚拟机居多，实际虚机有450台，由于CMDB里有统计不全或统计错误的问题，期间编写了获取ESXI 下虚机信息的脚本，参见 [get_esxi_host_and_vm_info](https://github.com/xoyabc/scripts/tree/master/get_esxi_host_and_vm_info)
  
  - 确认哪些机器需要搬迁，
  - 统计机器的SN号和所在机柜
  - 宿主机下所有虚拟机的IP地址，所属服务，开机自启设置(基于现有cmdb及脚本)
  - 宿主机下各个网口(vmnic0-11)所属vlan
  - 统计有心跳线的设备及对端设备IP
  - 心跳线所在网口及对端设备心跳线网口(heartbeat健康检查采用心跳线直连，避免广播风暴影响)
  - 确认各个机器所属的环境(一共有6套环境)
  - 确认机柜数量&机柜电压&电流上限
  - 3楼单机柜位置可容纳机器数量（10个）
  
  
## 迁移方案

  - 重要设备提前迁移
  
    涉及设备为核心代理，公共数据库等重要设备，提前迁移，规避宿主机起不来的风险
    
    刚开始采用的方案是导出导入模板的方案，导入导出相当于复制了2遍，非常耗时，后来采用 Vcenter 克隆的方案
    
  -  ESXI中的物理适配器(vmnic0-11)与物理网口对应关系
     
     由于各个vminic所在的 vlan 不同，在 ESXI 中只能看到vmnic网卡及vlan的对应关系，但是搬迁时是需要拔掉网线的，因此需要确认各个物理适配器(vmnic0-11)与机器网口的对应关系。待搬迁到3楼时，根据网络组提供的交换机端口，找到对应的物理网口，连接网线。
     
     默认情况下机器左侧第一个网口是vmnic0，第二个是vmnic1,依次类推即可。但是部分机器有后来加的网卡，这里又有三种情况：
     
     | 外加网卡分布  | ESXI 中适配器vmnic名称 | vmnic 适配器数字顺序 |
     | :---: | :---: | :---: | 
     | 一排2个网口 | 左侧的网口对应 vminic5， 右侧的网口对应vminic4 | 从右往左递增 |
     | 两排2个网口 | 第一排右侧的网口对应 vminic4，第二排左侧的网口对应 vminic7 | 自上而下，从右往左递增 |
     | 两排4个网口 | 第一排右侧的网口对应 vminic4，第二排左侧的网口对应 vminic11 | 自上而下，从右往左递增 |
     
     
     
     
 ## 搬迁前期去机房所做动作
 
    - 在设备前面贴IP标签，以便搬迁时快速找到对应设备
    
    - 设备背部网口打标签，以便搬迁到3楼后快速找到网口，插入交换机网线。
    
    以下为之前整理的设备背部网口标签说明
    
   | 标签内容  | 说明 | 搬迁后动作 |
    | :-----------: | :-----------: | :------------: |
    | 宿-管 | 宿主机管理网口 | 入到vlan200所在交换机口 |
    | 无 | 未插网线 | 依然不插网线 |
    | lo:39-40 | 192.168.100.39与192.168.100.40间的心跳线 | 根据网口标签连接心跳线 |
    | 未贴标签的网口 | 之前插的有网线，搬迁至3楼后均插入到trunk口 |待宿主机开机后，根据之前统计的vmnic0-7口与vlan的对应关系表，进入配置-->网络-->vmnic0-7-->属性-->编辑，修改vmnic的vlan id，和之前的一样 |

    
    
    
    
 
 

     
     
     
     
     
    
    
